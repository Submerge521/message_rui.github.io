name: 💌 WeChat Daily Push

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # UTC 时间每天 00:00

jobs:
  push-message:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ⚠️ 关键：获取完整历史以支持 git push

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 🚀 Run WeChat Push Script
        env:
          WECHAT_APPID: ${{ secrets.WECHAT_APPID }}
          WECHAT_APPSECRET: ${{ secrets.WECHAT_APPSECRET }}
          WECHAT_TEMPLATE_ID: ${{ secrets.WECHAT_TEMPLATE_ID }}
          WECHAT_USER_ID: ${{ secrets.WECHAT_USER_ID }}
          AMAP_KEY: ${{ secrets.AMAP_KEY}}
          CITY: ${{ secrets.CITY }}
          BIRTHDAY: ${{ secrets.BIRTHDAY }}
          RELATIONSHIP_DATE: ${{ secrets.RELATIONSHIP_DATE }}
          GF_NAME: ${{ secrets.GF_NAME }}
          CONSTELLATION: ${{ secrets.CONSTELLATION }}
        run: |
          python daily_message.py # 这个脚本会生成 latest_push.json

      - name: 📤 Commit and Push latest_push.json
        if: success()
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
          # 只提交 latest_push.json
          paths: |
            latest_push.json
          commit_message: "📝 自动更新: 发送微信推送并记录内容 $(date '+%Y-%m-%d %H:%M:%S')"
          author_name: GitHub Actions
          author_email: actions@github.com
