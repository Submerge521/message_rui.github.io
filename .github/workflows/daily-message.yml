# æ–‡ä»¶å: .github/workflows/push_message.yml

name: ğŸ’Œ WeChat Daily Push # Workflow çš„åç§°

# è§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å®šæ—¶è§¦å‘ (ä½¿ç”¨ POSIX cron è¯­æ³•)
  # é»˜è®¤è®¾ç½®ä¸º UTC æ—¶é—´æ¯å¤© 00:00 è§¦å‘ (å¯¹åº”åŒ—äº¬æ—¶é—´ 08:00)
  schedule:
    - cron: '0 0 * * *' # åˆ†é’Ÿ(0-59) å°æ—¶(0-23) æ—¥(1-31) æœˆ(1-12) æ˜ŸæœŸ(0-6, 0=å‘¨æ—¥)

# ä»»åŠ¡å®šä¹‰
jobs:
  push-message:
    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4 # ä½¿ç”¨å®˜æ–¹çš„ checkout action
        # âš ï¸ å…³é”®ï¼šä¸ºäº†èƒ½å¤Ÿæ¨é€æ›´æ”¹ï¼Œéœ€è¦è·å–å®Œæ•´çš„æäº¤å†å²
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²ï¼Œé¿å… git push å¤±è´¥

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5 # ä½¿ç”¨å®˜æ–¹çš„ setup-python action
        with:
          python-version: '3.13' # æŒ‡å®š Python ç‰ˆæœ¬

      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. è¿è¡Œæ¨é€è„šæœ¬
      # å°† GitHub Secrets ä½œä¸ºç¯å¢ƒå˜é‡ä¼ é€’ç»™ Python è„šæœ¬
      - name: ğŸš€ Run WeChat Push Script
        env:
          # å¿…é¡»çš„ Secrets
          WECHAT_APPID: ${{ secrets.WECHAT_APPID }}
          WECHAT_APPSECRET: ${{ secrets.WECHAT_APPSECRET }}
          WECHAT_TEMPLATE_ID: ${{ secrets.WECHAT_TEMPLATE_ID }}
          WECHAT_USER_ID: ${{ secrets.WECHAT_USER_ID }}
          AMAP_KEY: ${{ secrets.AMAP_KEY }}
          
          # å¯é€‰çš„ Secrets
          CITY: ${{ secrets.CITY }}
          BIRTHDAY: ${{ secrets.BIRTHDAY }}
          RELATIONSHIP_DATE: ${{ secrets.RELATIONSHIP_DATE }}
          GF_NAME: ${{ secrets.GF_NAME }}
          CONSTELLATION: ${{ secrets.CONSTELLATION }}
        run: |
          python daily_message.py # ç¡®ä¿ä½ çš„è„šæœ¬ä¼šç”Ÿæˆ latest_push.json

      # 5. ğŸ“¤ æäº¤å¹¶æ¨é€æ›´æ”¹ (å…³é”®æ–°å¢æ­¥éª¤)
      # åªæœ‰åœ¨ 'Run WeChat Push Script' æˆåŠŸåæ‰æ‰§è¡Œ
      - name: ğŸ“¤ Commit and Push latest_push.json
        if: success() # ç¡®ä¿å‰é¢çš„æ­¥éª¤éƒ½æˆåŠŸäº†
        # ä½¿ç”¨ä¸“é—¨çš„ action æ¥æ¨é€ï¼Œå¤„ç† GITHUB_TOKEN æƒé™æ›´å¯é 
        uses: ad-m/github-push-action@master 
        with:
          # ä½¿ç”¨ GitHub è‡ªåŠ¨æä¾›çš„ GITHUB_TOKEN
          # è¯¥ token å…·æœ‰å†™å…¥ä»“åº“çš„æƒé™ï¼ˆåœ¨ workflow å†…éƒ¨è§¦å‘ï¼‰
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # æ¨é€åˆ°å“ªä¸ªåˆ†æ”¯
          # ${{ github.ref }} ä¼šè‡ªåŠ¨è·å–å½“å‰è§¦å‘ workflow çš„åˆ†æ”¯ (å¦‚ refs/heads/main)
          branch: ${{ github.ref }}
          # è¦æäº¤çš„æ–‡ä»¶
          # æˆ‘ä»¬åªå…³å¿ƒ latest_push.json å’Œå¯èƒ½çš„ index.html (å¦‚æœå®ƒä¹Ÿè¢«ä¿®æ”¹äº†)
          # å¦‚æœä½ çš„ index.html æ²¡æœ‰è¢« daily_message.py ä¿®æ”¹ï¼Œå¯ä»¥åªå†™ latest_push.json
          paths: |
            latest_push.json
            # index.html # å¦‚æœä½ ä¹Ÿåœ¨ daily_message.py ä¸­ä¿®æ”¹äº† index.htmlï¼Œå°±å–æ¶ˆæ³¨é‡Šè¿™è¡Œ
          # æäº¤ä¿¡æ¯
          commit_message: "ğŸ“ è‡ªåŠ¨æ›´æ–°: å‘é€å¾®ä¿¡æ¨é€å¹¶è®°å½•å†…å®¹ $(date '+%Y-%m-%d %H:%M:%S')"
          # è®¾ç½®ä½œè€…ä¿¡æ¯ (å¯é€‰)
          author_name: GitHub Actions
          author_email: actions@github.com
